INFILE=`awk "NR==${SLURM_ARRAY_TASK_ID}" /rds/user/cjr78/hpc-work/ChIP/Foxa2/samplesheet.txt`

cd /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastqc/

fastqc /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/merged/${INFILE}_R1_001.fastq.gz
fastqc /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/merged/${INFILE}_R2_001.fastq.gz

cd /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/merged/ 

trimmomatic PE -threads $SLURM_NTASKS -phred33 /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/merged/${INFILE}_R1_001.fastq.gz /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/merged/${INFILE}_R2_001.fastq.gz ${INFILE}_R1_trimmed.fastq.gz ${INFILE}_R1_failed.fastq.gz ${INFILE}_R2_trimmed.fastq.gz ${INFILE}_R2_failed.fastq.gz ILLUMINACLIP:/rds/user/cjr78/hpc-work/scripts/TruSeq3-SE.fa:2:30:10:1:true LEADING:5 TRAILING:5 SLIDINGWINDOW:4:15 MINLEN:30

cd /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastqc/
fastqc /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/merged/${INFILE}_R1_trimmed.fastq.gz
fastqc /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/merged/${INFILE}_R2_trimmed.fastq.gz

cd /rds/user/cjr78/hpc-work/ChIP/Foxa2
mkdir bowtie
cd bowtie
mkdir ${INFILE}
cd ${INFILE}
 
bowtie2 -p $SLURM_NTASKS --dovetail -X 2000 -t -x /rds/user/cjr78/hpc-work/References/Mus_musculus/UCSC/mm10/Sequence/Bowtie2Index/genome -1 /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/${INFILE}_R1_trimmed.fastq.gz -2 /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/${INFILE}_R2_trimmed.fastq.gz | samtools view -b -F 4 -f 2 -q30 - > ${INFILE}.bam
#convert to bam
#-b ensures a bam output
#-F 4 ensures only mapped reads are carried over (-f 2 in other instances indicates to keep correctly paired reads)
#q30 only take good quality reads
samtools view -b -F 4 -f 2 -q30 ${INFILE}.sam > ${INFILE}.bam

#remove blacklist
intersectBed -v -abam ${INFILE}fixed.bam -b /rds/user/cjr78/hpc-work/scripts/mm10.blacklist.bed > ${INFILE}_blacklist.bam

#sort bam
samtools sort ${INFILE}_blacklist.bam > ${INFILE}_blacklist_sorted.bam

#remove duplicates

picard MarkDuplicates INPUT=${INFILE}_blacklist_sorted.bam OUTPUT=${INFILE}_blacklist_sorted_markeddup.bam METRICS_FILE=${INFILE}_blacklist_sorted_dup_stats.txt 

#sort
samtools sort ${INFILE}_blacklist_sorted_markeddup.bam > ${INFILE}_final.bam

#samtools index ${INFILE}_final.bam

rm *.sam
rm *_blacklist*.bam
rm *_blacklist*.bam.bai

#Obtain reads from Drosophila genome
bowtie2 -p $SLURM_NTASKS -t -x /rds/user/cjr78/hpc-work/References/Drosophila_melanogaster/UCSC/dm3/Sequence/Bowtie2Index/genome -1 /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/${INFILE}_R1_trimmed.fastq.gz -2 /rds/user/cjr78/hpc-work/ChIP/Foxa2/fastq/${INFILE}_R2_trimmed.fastq.gz | samtools view -bF 4 -f 2 -q30 - > ${INFILE}_dm3.bam


##scale BAM files using spike-in ratios.
cd /rds/user/cjr78/hpc-work/ChIP/Foxa2/bowtie/*_S${SLURM_ARRAY_TASK_ID}

INFILE=`awk "NR==${SLURM_ARRAY_TASK_ID}" /rds/user/cjr78/hpc-work/ChIP/Foxa2/bowtie/scale_factors.txt`

samtools view -b -s $INFILE *_final.bam > ${SLURM_ARRAY_TASK_ID}_final_scaled.bam

##call peaks per condition

cd macs2
mkdir $INFILE

cd $INFILE
cd merged
#CL19
macs2 callpeak -t /rds/user/cjr78/hpc-work/ChIP/Foxa2/bowtie_verysensitive/$INFILE/*_final.bam -f BAMPE -n $INFILE --outdir /rds/user/cjr78/hpc-work/ChIP/Foxa2/macs2/$INFILE -g mm -q 0.01 --SPMR -B --keep-dup all --call-summits 
#CL1
macs2 callpeak -t /rds/user/cjr78/hpc-work/ChIP/Foxa2/bowtie/*{5..7/*_final_scaled.bam -c /rds/user/cjr78/hpc-work/ChIP/Foxa2/bowtie/CL1_IgG_S8/8_final_scaled.bam -f BAMPE -n CL1_merged --outdir /rds/user/cjr78/hpc-work/ChIP/Foxa2/macs2/CL1 -g mm -q 0.01 --SPMR -B --keep-dup all --call-summits 
#FLFL
macs2 callpeak -t /rds/user/cjr78/hpc-work/ChIP/Foxa2/bowtie/*{1..3/*_final_scaled.bam -c /rds/user/cjr78/hpc-work/ChIP/Foxa2/bowtie/FLFL_IgG_S4/4_final_scaled.bam -f BAMPE -n FLFL_merged --outdir /rds/user/cjr78/hpc-work/ChIP/Foxa2/macs2/FLFL -g mm -q 0.01 --SPMR -B --keep-dup all --call-summits 
